name: Cleanup Old Workflow Runs
on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      days:
        description: 'Runs Ã¤lter als X Tage lÃ¶schen'
        required: false
        default: '7'
      minimum_runs:
        description: 'Mindestanzahl der zu behaltenden Runs'
        required: false
        default: '5'
jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    
    steps:
      - name: Alte Workflow Runs lÃ¶schen
        uses: actions/github-script@v7
        with:
          script: |
            const days = ${{ github.event.inputs.days || 7 }};
            const keepMinimum = ${{ github.event.inputs.minimum_runs || 5 }};
            const daysAgo = new Date(Date.now() - days * 24 * 60 * 60 * 1000);
            
            console.log(`ğŸ—‘ï¸ LÃ¶sche Runs Ã¤lter als ${days} Tage (vor ${daysAgo.toISOString()})`);
            console.log(`ğŸ“Š Behalte mindestens ${keepMinimum} Runs pro Workflow`);
            
            const workflows = await github.rest.actions.listRepoWorkflows({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            let totalDeleted = 0;
            
            for (const workflow of workflows.data.workflows) {
              console.log(`\nğŸ“‹ Workflow: ${workflow.name}`);
              
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: workflow.id,
                per_page: 100,
              });
              
              const sortedRuns = runs.data.workflow_runs.sort((a, b) => 
                new Date(b.created_at) - new Date(a.created_at)
              );
              
              let deleted = 0;
              
              for (let i = 0; i < sortedRuns.length; i++) {
                const run = sortedRuns[i];
                const runDate = new Date(run.created_at);
                
                if (i < keepMinimum) {
                  console.log(`  âœ… Behalten: Run #${run.run_number} (${runDate.toISOString()}) - Top ${keepMinimum}`);
                  continue;
                }
                
                if (runDate < daysAgo) {
                  try {
                    await github.rest.actions.deleteWorkflowRun({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      run_id: run.id,
                    });
                    console.log(`  ğŸ—‘ï¸ GelÃ¶scht: Run #${run.run_number} (${runDate.toISOString()})`);
                    deleted++;
                    totalDeleted++;
                  } catch (error) {
                    console.log(`  âŒ Fehler beim LÃ¶schen von Run #${run.run_number}: ${error.message}`);
                  }
                } else {
                  console.log(`  â­ï¸ Ãœbersprungen: Run #${run.run_number} (${runDate.toISOString()}) - Zu neu`);
                }
              }
              
              console.log(`  ğŸ“Š ${deleted} Runs gelÃ¶scht`);
            }
            
            console.log(`\nğŸ‰ FERTIG! Insgesamt ${totalDeleted} Runs gelÃ¶scht.`);
