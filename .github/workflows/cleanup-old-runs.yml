name: Cleanup Old Workflow Runs

on:
  schedule:
    - cron: '0 2 * * *' # T√§glich um 2:00 Uhr
  workflow_dispatch:
    inputs:
      days:
<<<<<<< HEAD
        description: 'Runs √§lter als X Tage l√∂schen'
        required: false
        default: '1'
      minimum_runs:
        description: 'Mindestanzahl der zu behaltenden Runs'
        required: false
        default: '2'
=======
        description: 'L√∂sche Runs, die √§lter sind als X Tage'
        required: true
        default: '1'
      minimum_runs:
        description: 'Behalte mindestens X Runs pro Workflow'
        required: true
        default: '2'

>>>>>>> e6620d8 (feat: Add robust workflow cleanup script)
jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read

    steps:
      - name: üóëÔ∏è Alte Workflow Runs l√∂schen
        uses: actions/github-script@v7
        with:
          script: |
<<<<<<< HEAD
            const days = ${{ github.event.inputs.days || 1 }};
            const keepMinimum = ${{ github.event.inputs.minimum_runs || 2 }};
            const daysAgo = new Date(Date.now() - days * 24 * 60 * 60 * 1000);
=======
            const days = parseInt('${{ github.event.inputs.days || 1 }}');
            const minRuns = parseInt('${{ github.event.inputs.minimum_runs || 2 }}');
            console.log(`L√∂sche Runs √§lter als ${days} Tage, behalte min. ${minRuns} Runs.`);
>>>>>>> e6620d8 (feat: Add robust workflow cleanup script)
            
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const now = Date.now();
            
            // Hole alle Workflows
            const workflows = await github.rest.actions.listRepoWorkflows({
              owner,
              repo,
            });
            
            console.log(`Gefunden: ${workflows.data.total_count} Workflows.`);

            for (const workflow of workflows.data.workflows) {
              console.log(`Pr√ºfe Workflow: ${workflow.name} (${workflow.id})`);
              
              // Hole Runs f√ºr diesen Workflow (sortiert nach neueste zuerst)
              const runs = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id: workflow.id,
                per_page: 100, // Max 100 pro Batch
              });
              
              let keptCount = 0;
              let deletedCount = 0;
              
              for (const run of runs.data.workflow_runs) {
                const ageMs = now - new Date(run.created_at).getTime();
                const ageDays = ageMs / (1000 * 60 * 60 * 24);
                
                // Logik zum Behalten:
                // 1. Ist einer der neuesten N Runs? (minRuns)
                // 2. Ist j√ºnger als X Tage?
                
                if (keptCount < minRuns) {
                  // Behalte Run (Top N)
                  keptCount++;
                  continue;
                }
                
                if (ageDays <= days) {
                   // Behalte Run (Zu neu)
                   continue;
                }
                
                // L√∂sche Run
                console.log(`L√∂sche Run ${run.id} (Erstellt: ${run.created_at}, Alter: ${ageDays.toFixed(1)} Tage)`);
                try {
                  await github.rest.actions.deleteWorkflowRun({
                    owner,
                    repo,
                    run_id: run.id,
                  });
                  deletedCount++;
                } catch (e) {
                  console.log(`Fehler beim L√∂schen von Run ${run.id}: ${e.message}`);
                }
              }
              console.log(`Workflow ${workflow.name}: ${deletedCount} gel√∂scht.`);
            }
